# 3 语法

- `iptables [-t table] command [match] [target/jump]`
    - `-t table`
        - 指定哪个表，默认是`filter` ，可选的有`nat`、`mangle`
- command
    - LS
        - `iptables -[LS] [chain [rulenum]] [options]`
        - `-L`  显示已使用的规则集
            - `-n`  输出时显示ip、端口号
            - `--line-numbers`  显示每条规则的编号
            - `-x` 显示计数
            - `-t <filter>`  显示filter表的规则
        - `-S --list-rules`
            - 相当于命令列表
    - ACD
        - `iptables -[ACD] chain rule-specification [options]`
        - `-A --apend`  添加链
        - `-D --delete` 删除链
            - `iptables -D chain rulenum [options]`
        - `-C --check`   检查链
    - `-I --insert`   插入链
        - `iptables -I chain [rulenum] rule-specification [options]`
    - `-R --replace`   替换链
        - `iptables -R chain rulenum rule-specification [options]`
    - FZ
        - `iptables -[FZ] [chain] [options]`
        - `-F --fulsh` 清空链
        - `-Z --zero`    清空链的计数
    - NX
        - `iptables -[NX] chain`
        - `-N --new`  创建自定义链
        - `-X --delete-chain`  删除自定义链，删除时不能被引用
    - `-E --rename-chain` 更新名字
        - `iptables -E old-chain-name new-chain-name`
    - `-P --policy`
        - `iptables -P chain target [options]`
        - 为链设置默认的target，target被成为策略。所有不符合规范的包都会使用该策略。
        - 只有内建的链才可以使用该规则，内建的链和自定义链都不能作为策略使用
- options
    - 通用匹配参数
        - `-j --jump target/jumps`
            - `target/jump`决定符合条件的包到何处去
            - 示例：`iptables -A INPUT -p tcp -j tcp_packets`
                - 这样我们就会从INPUT链跳入tcp_packets链，开始在tcp_packets中的旅行。如果到达了tcp_packets链的结尾（也 就是未被链中的任何规则匹配），则会退到INPUT链的下一条规则继续它的旅行。如 果在子链中被ACCEPT了，也就相当于在父链中被ACCEPT了，那么它不会再经过父链中的其他规则
            - `target`
                - ACCEPT， 直接接收
                - DROP，  直接删除，不会响应发送方，好的办法是用 REJECT
                - REJECT，拒绝，会回复响应信息给发送方
                - DNAT，网络地址转换，适用于公司内网
                    - `iptables -t nat -A PREROUTING -p tcp -d 15.45.23.67 --dport 80 -j DNAT --to-destination 192.168.1.1-192.168.1.10`
                    - 把所有发往地址15.45.23.67的包都转发到一段LAN使用的私有地址中，即192.168.1.1到 192.168.1.10
                    - 这条规则会造成一些麻烦的影响，`[文档地址](https://www.frozentux.net/iptables-tutorial/cn/iptables-tutorial-cn-1.1.19.html#HOWARULEISBUILT)`
                - LOG，记录包的有关信息，通常用于调试
                - RETURN，类似于函数，作用是结束本层的匹配
            - jump
        - `-p —-protocol <name>`
            - `iptables -A INPUT -p tcp`，name必须是在`/etc/protocol`定义的
            - 默认值是 `ALL`，可以使用 `tcp,udp`，也可以取反 `!tcp`
            - 也可以使用对应的数字，tcp是6，udp是17
        - `-s --src --source <ip>`
            - 以IP源地址匹配包，默认是所有地址，可以使用子网掩码，可以取反
        - `-d --dst --destination <ip>`
            - 以IP目的地址匹配包
        - `-i --in --interface <eth>`
            - 以包进入本地所使用的网络接口来匹配包
            - 只能作用于INPUT，FORWARD和 PREROUTING这三个链
        - `-o --out-interface <eth>`
            - 以包离开本地所使用的网络接口来匹配包
    - TCP 子参数
        - 列举了两个主要参数，同样适用于UDP协议
        - `--sport --source-port <port>`
            - 基于包的源端口来匹配包，主要形式有：
                - 默认所有端口
                - 单个端口，比如80
                - 连续的端口，比如 20:80， :80，80:
                - 取反，!22, !22:80
                - 如果要使用不连续的端口，`-m multiport --dport 22,53,80,110`
        - `--dport --destination-port <port>`
            - 基于包的目的端口来匹配包，语法同`—-sport`
    - 显示匹配 `-m <name>`
-