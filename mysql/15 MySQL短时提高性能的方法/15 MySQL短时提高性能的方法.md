# MySQL短时提高性能的方法

- 应用场景
    - 在业务高发时期，需要短期、临时性的提高一些性能，并需要预知其带来的风险
- 短连接风暴
    - 正常的短连接模式就是连接到数据库后，执行很少的连接就断开。在业务高峰事情，就可能出现连接数暴涨的情况。
    - MySQL建立连接的过程，成本还是很高的。除了正常的三次握手以外，还需要做登陆判断和读写权限判断。
    - 在数据库压力比较大的时候，一旦数据库处理连接时慢了一点，连接数量就会暴涨。
        - `show variables like "max_connections";`   最大连接数量
    - 一旦连接数量超过指定的最大连接数量，系统就会拒绝接下来的请求，提示 Too many connections。对于被拒绝的连接，从业务角度就是数据库不可用。
    - 在机器负载比较高的情况下，处理请求的时间也变长，提高了连接的占用。
    - 对于这种情况，理想的情况就是调高 `max_connections` 的值，虽然可以提供连接数量，但是考虑到机器的能力，大量的资源可能消耗在连接校验上，结果可能适得其反
    - 一些`建议的方法`，但是是有损的
        - 先处理掉那些占着连接但是不工作的线程
            - 通过 `show processlist` 查看线程状态，`kill connection` 断开连接
        - 减少连接过程的消耗
            - 让数据跳过权限验证阶段，启动时添加 `—-skip-grant-tables` 参数
- 慢查询性能问题
    - 引发性能的慢查询，主要有三种
        - 索引没有设计好
            - 可以通过紧急创建索引来解决，执行 alter table ，由于MySQL已经支持 online DDL，但是对于数据库已经挂掉的情况需要手动执行提升效率
            - 效率最高的情况，情况是一主一备
                - 备库上执行 set sql_log_bin=off 关闭binlog，执行alter table 加上索引
                - 执行主备切换
                - 主库上执行set sql_log_bin=off，然后执行alter table
        - SQL 语句没写好
        - MySQL 选错了索引
            - 可以通过force index
- QPS突增的问题
    - 如果是由程序的BUG的引起的，最理想的情况就是把这个功能下掉，服务自然恢复
    - 而下掉一个功能，从数据库的角度处理的话，对于不同的背景有不同的方法
        1. 由全新的业务BUG引起的，移除白名单
        2. 新功能使用的是全新的数据库用户，可以把这个账号删除掉。
        3. 通过处理语句来限制，把压力最大的SQL直接重写为 select 1 返回；
    -