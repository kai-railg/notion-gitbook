# 1 ES的基本概念

- 文档 Document
    - ES是面向文档的，文档是可搜索数据的最小单位
        - 比如一行日志、一个PDF的具体内容
    - 文档会被序列化成JSON格式
        - 字段的类型可以指定或ES自动推算
    - 每个文档都有一个 Unique ID
    - 每篇文档的`元数据`用于标记文档的相关信息
        - _index   文档所属的索引名称
        - _type     文档所属的类型名称
        - _id    文档唯一ID
        - _source   文档原始的JSON数据
        - _version  文档的版本信息
        - _score   文档相关性打分
- 索引  Index
    - 索引是文档的容器，是一类文档的结合
        - Index 体现逻辑空间的概念，每个索引都有自己的mapping定义，用于定义包含的文档和字段类型
        - Shard 体现物理上的概念，索引中的数据分散在 Shard 上。
    - 索引的 mapping 和 setting
        - mapping 定义文档字段的类型
        - setting 定义不同的数据分布
    - 
- 节点
    - 节点就是ES实例
    - 每个节点都有名字，通过配置文件或命令行 -E node.name=x 指定
    - 每个节点启动后，会分配一个UID，保存在data目录下
    - Master-eligible nodes
        - 每个节点启动后，默认就是一个Master-eligible node，可以设置 node.master=false 禁止
        - Master-eligible node 会参加选主流程
        - 当地一个节点启动后，他会将自己选举成Master 节点
    - Master Node
        - 每个节点都保存着 Master的信息，只有  Master节点才可以修改集群的状态信息
            - 集群状态 维护了一个集群中必要的信息
                - 所有的节点信息
                - 所有的索引和其 Mapping、Setting的信息
                - 分片的路由信息
    - Date node
        - 可以保存数据的节点， 负责保存分片数据
        - 
    - Coordinating node
        - 接受Client的请求，将请求分发到合适的节点上，最后将结果汇集在一起
        - 每个节点都默认起到 Coordinating node 的作用
    - Hot & Warm node
        - 冷热节点，不同硬件配置的 Date node，用来实现 Hot & Warm架构，降低集群部署成本
    - Machine Learning Node
        - 负责跑机器学习的node，用来做异常检测
    - 节点类型的配置
        - 一个节点可以承担多种角色
        - 生产环境中 应该设置成单独角色的节点
        - 

        [node config](https://www.notion.so/0f219a0f6a274077ae06613ac0b0a83d)

- 分片
    - 一个分片是一个运行Lucene Index（实例）
        - 一个分片是一个底层的工作单元，以及它本身就是一个完整的搜索引擎
        - 一个分片保存全部数据的一部分，分片是数据的容器
        - ES利用分片将数据分配到集群的各个节点中
        - 分片分为主分片和副本分片
            - 副本分片是主分片的拷贝
            - 副本分片作为冗余备份，以及提供文档的读操作
            - 副本分片和主分片在同一台机器上是没有意义的
            - 分布
                - 三台Node，两个P0，P1 主分片，每个主分片有两个副本分片

                ![1%20ES%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%2071971a081ec44d33b917d1578071b3cb/Untitled.png](1%20ES%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%2071971a081ec44d33b917d1578071b3cb/Untitled.png)

    - 主分片用以解决数据水平扩展的问题。
        - 通过主分片，可以将一份索引的数据，`分散`到集群内的多个节点上
    - 主分片数在索引创建时指定，后续不允许修改，除非reindex
    - 对于生产环境中分片的设定，需要提前做好容量规划
        - 分片设置过小
            - 导致后续无法增加节点实现水平扩展
            - 单个分片的数量太大，导致数据重新索引耗时
        - 分片设置过大，默认主分片设置为1
            - 影响搜索结果的相关性打分，影响统计结果的正确性
            - 单个节点上过多的分片，会导致资源浪费，同时影响性能
    - 健康状况
        - `GET _cluster/headlth`
            - Green  主分片和副本都分配正常
            - Yellow  主分片全部正常分配，有副本分片不能正常分配
            - Red      主分片未能正常分配，比如磁盘容量不足以创建一个新的索引
- 副本
    - 副本，也叫副本分片，用以解决数据高可用的问题。
    - 副本是主分片的拷贝
    - 副本分片数可以动态调整
    - 增加副本数，还可以提供读取的吞吐